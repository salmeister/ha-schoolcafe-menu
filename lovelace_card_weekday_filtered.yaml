# Enhanced SchoolCafe Menu Card with Weekday Filtering
# Uses the new sensor naming scheme and is_weekday attribute

type: vertical-stack
title: 🍽️ PLHS Lunch Menu
cards:
  # Today's Detailed Menu (only show if it's a weekday)
  - type: conditional
    conditions:
      - condition: template
        value_template: >
          {{ state_attr('sensor.schoolcafe_blue_line_today', 'is_weekday') == true or
             state_attr('sensor.schoolcafe_gold_line_today', 'is_weekday') == true }}
    card:
      type: entities
      title: >
        📅 Today - {{ now().strftime('%A, %B %d') }}
      entities:
        # Blue Line with details
        - type: conditional
          conditions:
            - condition: template
              value_template: >
                {{ states('sensor.schoolcafe_blue_line_today') not in ['unavailable', 'unknown', 'No items available'] }}
          row:
            entity: sensor.schoolcafe_blue_line_today
            name: "🔵 Blue Line"
            icon: mdi:food
            secondary_info: >
              {% set items = state_attr('sensor.schoolcafe_blue_line_today', 'items') %}
              {% if items and items|length > 0 %}
                {% set item = items[0] %}
                {{ item.calories }} cal • {{ item.rating }}⭐ • {{ item.likes_percentage }}% like it
              {% endif %}
        
        # Gold Line with details
        - type: conditional
          conditions:
            - condition: template
              value_template: >
                {{ states('sensor.schoolcafe_gold_line_today') not in ['unavailable', 'unknown', 'No items available'] }}
          row:
            entity: sensor.schoolcafe_gold_line_today
            name: "🟡 Gold Line"
            icon: mdi:food
            secondary_info: >
              {% set items = state_attr('sensor.schoolcafe_gold_line_today', 'items') %}
              {% if items and items|length > 0 %}
                {% set item = items[0] %}
                {{ item.calories }} cal • {{ item.rating }}⭐ • {{ item.likes_percentage }}% like it
              {% endif %}

        # Allergen Alert (if any items have common allergens)
        - type: conditional
          conditions:
            - condition: template
              value_template: >
                {% set blue_items = state_attr('sensor.schoolcafe_blue_line_today', 'items') %}
                {% set gold_items = state_attr('sensor.schoolcafe_gold_line_today', 'items') %}
                {% set all_allergens = [] %}
                {% if blue_items %}
                  {% for item in blue_items %}
                    {% set all_allergens = all_allergens + item.allergens %}
                  {% endfor %}
                {% endif %}
                {% if gold_items %}
                  {% for item in gold_items %}
                    {% set all_allergens = all_allergens + item.allergens %}
                  {% endfor %}
                {% endif %}
                {{ all_allergens|length > 0 }}
          row:
            type: section  
            label: >
              ⚠️ Allergens: {% set blue_items = state_attr('sensor.schoolcafe_blue_line_today', 'items') %}
              {% set gold_items = state_attr('sensor.schoolcafe_gold_line_today', 'items') %}
              {% set all_allergens = [] %}
              {% if blue_items %}
                {% for item in blue_items %}
                  {% set all_allergens = all_allergens + item.allergens %}
                {% endfor %}
              {% endif %}
              {% if gold_items %}
                {% for item in gold_items %}
                  {% set all_allergens = all_allergens + item.allergens %}
                {% endfor %}
              {% endif %}
              {{ all_allergens|unique|join(', ') }}

  # Smart Week View - Only shows weekdays, skips weekends automatically
  - type: entities
    title: "📋 Upcoming School Days"
    entities:
      # Tomorrow (only if weekday)
      - type: conditional
        conditions:
          - condition: template
            value_template: >
              {{ state_attr('sensor.schoolcafe_blue_line_tomorrow', 'is_weekday') == true }}
        row:
          entity: sensor.schoolcafe_blue_line_tomorrow
          name: "Tomorrow"
          icon: mdi:calendar-today
          secondary_info: >
            {% if states('sensor.schoolcafe_blue_line_tomorrow') not in ['unavailable', 'unknown', 'No items available'] %}
              🔵 {{ states('sensor.schoolcafe_blue_line_tomorrow') }}
            {% elif states('sensor.schoolcafe_gold_line_tomorrow') not in ['unavailable', 'unknown', 'No items available'] %}
              🟡 {{ states('sensor.schoolcafe_gold_line_tomorrow') }}
            {% else %}
              No Menu Available
            {% endif %}

      # Day +2 (only if weekday)
      - type: conditional
        conditions:
          - condition: template
            value_template: >
              {{ state_attr('sensor.schoolcafe_blue_line_today_plus2', 'is_weekday') == true }}
        row:
          entity: sensor.schoolcafe_blue_line_today_plus2
          name: >
            {{ (now().date() + timedelta(days=2)).strftime('%A') }}
          icon: mdi:calendar-today
          secondary_info: >
            {% if states('sensor.schoolcafe_blue_line_today_plus2') not in ['unavailable', 'unknown', 'No items available'] %}
              🔵 {{ states('sensor.schoolcafe_blue_line_today_plus2') }}
            {% elif states('sensor.schoolcafe_gold_line_today_plus2') not in ['unavailable', 'unknown', 'No items available'] %}
              🟡 {{ states('sensor.schoolcafe_gold_line_today_plus2') }}
            {% else %}
              No Menu Available
            {% endif %}

      # Day +3 (only if weekday)
      - type: conditional
        conditions:
          - condition: template
            value_template: >
              {{ state_attr('sensor.schoolcafe_blue_line_today_plus3', 'is_weekday') == true }}
        row:
          entity: sensor.schoolcafe_blue_line_today_plus3
          name: >
            {{ (now().date() + timedelta(days=3)).strftime('%A') }}
          icon: mdi:calendar-today
          secondary_info: >
            {% if states('sensor.schoolcafe_blue_line_today_plus3') not in ['unavailable', 'unknown', 'No items available'] %}
              🔵 {{ states('sensor.schoolcafe_blue_line_today_plus3') }}
            {% elif states('sensor.schoolcafe_gold_line_today_plus3') not in ['unavailable', 'unknown', 'No items available'] %}
              🟡 {{ states('sensor.schoolcafe_gold_line_today_plus3') }}
            {% else %}
              No Menu Available
            {% endif %}

      # Day +4 (only if weekday)
      - type: conditional
        conditions:
          - condition: template
            value_template: >
              {{ state_attr('sensor.schoolcafe_blue_line_today_plus4', 'is_weekday') == true }}
        row:
          entity: sensor.schoolcafe_blue_line_today_plus4
          name: >
            {{ (now().date() + timedelta(days=4)).strftime('%A') }}
          icon: mdi:calendar-today
          secondary_info: >
            {% if states('sensor.schoolcafe_blue_line_today_plus4') not in ['unavailable', 'unknown', 'No items available'] %}
              🔵 {{ states('sensor.schoolcafe_blue_line_today_plus4') }}
            {% elif states('sensor.schoolcafe_gold_line_today_plus4') not in ['unavailable', 'unknown', 'No items available'] %}
              🟡 {{ states('sensor.schoolcafe_gold_line_today_plus4') }}
            {% else %}
              No Menu Available
            {% endif %}

      # Day +5 (only if weekday)
      - type: conditional
        conditions:
          - condition: template
            value_template: >
              {{ state_attr('sensor.schoolcafe_blue_line_today_plus5', 'is_weekday') == true }}
        row:
          entity: sensor.schoolcafe_blue_line_today_plus5
          name: >
            {{ (now().date() + timedelta(days=5)).strftime('%A') }}
          icon: mdi:calendar-today
          secondary_info: >
            {% if states('sensor.schoolcafe_blue_line_today_plus5') not in ['unavailable', 'unknown', 'No items available'] %}
              🔵 {{ states('sensor.schoolcafe_blue_line_today_plus5') }}
            {% elif states('sensor.schoolcafe_gold_line_today_plus5') not in ['unavailable', 'unknown', 'No items available'] %}
              🟡 {{ states('sensor.schoolcafe_gold_line_today_plus5') }}
            {% else %}
              No Menu Available
            {% endif %}

      # Day +6 (only if weekday)
      - type: conditional
        conditions:
          - condition: template
            value_template: >
              {{ state_attr('sensor.schoolcafe_blue_line_today_plus6', 'is_weekday') == true }}
        row:
          entity: sensor.schoolcafe_blue_line_today_plus6
          name: >
            {{ (now().date() + timedelta(days=6)).strftime('%A') }}
          icon: mdi:calendar-today
          secondary_info: >
            {% if states('sensor.schoolcafe_blue_line_today_plus6') not in ['unavailable', 'unknown', 'No items available'] %}
              🔵 {{ states('sensor.schoolcafe_blue_line_today_plus6') }}
            {% elif states('sensor.schoolcafe_gold_line_today_plus6') not in ['unavailable', 'unknown', 'No items available'] %}
              🟡 {{ states('sensor.schoolcafe_gold_line_today_plus6') }}
            {% else %}
              No Menu Available
            {% endif %}

  # Weekend message (only show on weekends or when no school days are available)
  - type: conditional
    conditions:
      - condition: template
        value_template: >
          {{ state_attr('sensor.schoolcafe_blue_line_today', 'is_weekday') == false and
             state_attr('sensor.schoolcafe_gold_line_today', 'is_weekday') == false }}
    card:
      type: markdown
      content: |
        ## 🏖️ Weekend - No School
        
        Enjoy your weekend! School menus will be available again on the next school day.
        
        Current sensors are tracking weekend dates. The integration will automatically resume showing school day menus when weekdays return.